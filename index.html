<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeRoom</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABJElEQVQ4T6WT0U0CURBF7wOCFdhA7cAOSAexA1JCO7AD7cAKtAM7sAM70A5IB3YQlgiB8GYzJLCQl3WTzJ93Z+7M3LtD5VOr3H9egQdgBxyBZ+CoBQ/AEnhT8wY8qk4BZsCnVgV4Bd5VJwBz4EsrB7gFvlUzwEw7F3gGflQzwFw7F3gBflUzwEI7F3gD/lQzwFI7F/gA/lUzwEo7F/gEjto5wFq7H8At8Kc6Btho9wO4A/5VxwBb7X4AD8BBdQyw0+4H8AQcVccAe+1+AC/AUXUMcNDuB/AGnFRHAEftfgAfwFl1BHDW7gfwBVxURwAX7X4A38BVdQRw1e4H8ANcVUcAN+1+AL9AqDoCCNo9ANdQrB1F2/8LAAAAAElFTkSuQmCC">
    <script src="https://cdn.jsdelivr.net/npm/web3@4.0.3/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ably@1.2.48/build/ably.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.9/dist/purify.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --primary-color: #4CAF50;
            --hover-color: #f5f5f5;
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --border-color: #333333;
            --hover-color: #2d2d2d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        #header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 10px;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            display: flex;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        #logo {
            width: 40px;
            height: 40px;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACIUlEQVRYhe2WP0gCURjFnygEQQ0NLQ4FQUNBQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ4NDQ0NDQ0NDQ0ODQ0NDQ0NDQ0NDQ0NDQ8OjwxOvg+/5n0QduOHevd/97rvv3Xv3hWrVqgD5gC7gA8oA9IARV9EJHABfgj3A5yp6gVfBGnDoKk4Cr4J94MxVnAaeBfvAuas4A7wI9oELV3EGeBHsA1eu4izwKtgHrl3FOeBNsA/cuIpzwLtgH7hzFeeBD8E+cO8qLgCfgn3gwVVcBL4E+8Cjq7gEfAv2gSdXcRn4EewDz67iCvAr2AdeXMVV4E+wD7y6imvAv2AfeHMV14GCYB/4cBXXgaJgH/h0FTeAkmAf+HIVN4GyYB/4dhW3gIpgH/hxFbeBqmAf+HUVd4CaYB/4cxX3gLpgH/h3FQ+AhmAf+J9VnAVyQFpwBmgK9oE/V3EeSABRwTGgJdgHvl3FRSACBAUngLZgH/h0FZeBEBAQnAQ6gn3gw1VcBfxA8L8rqAFdoC84C/QE+8Cbq7gOBAGf4DTQF+wDr67iBuAHfIJzQFewD7y4iptACPAKzgNtwT7w7CpuARHAIzgJdAT7wJOruA1EAY/gNNAV7AOPrqIOEAe8gtNAW7AP3LuKekAC8AtOAy3BPnDnKuoDSSAgOAk0BfvArauoD6SAoOA40BTsAzeuogGQBkKCY0BDsA9cu4qGQAYIC44CdcE+cOUqGgFZICw4DNQE+8Clq2gM5ICI4BBQFewDF66iCZAHooKDQEWwD5y5iqZAAYgJDgBlwT5w6iqaAUUgLjgEFAT7wImraA6UgKTgCJAT7APHLkUrQBmIC44CGcE+cOQqtgJUgJTgGJAS7AOHrmJloApkBMeBhGAf2HcVWwVqQFZwAogL9oE9V7F1oA7kBKeAiGAf2HUV2wAaQF5wGggK9oFtV7FNoAkUBKeBgGAf2HIV2wJaQElwBvAL9oFNV7FtoA1UBGcBn2Af2HAV2wE6QE1wDvAJ9oF1V7FdoAu0BOcBn2AfWHMV2wN6QE9wAfAJ9oFVV7F9oA8MBBcBn2AfWHEVOwAGwFBwCfAJ9oFlV7FDYAiMBJcBn2AfWHIVOwJGwFhwBfAJ9oElV7FjYAxMBFcBn2AfWHQVOwEmwFRwDfAJ9oEFV7FTYArMBNcBn2AfmHcVOwNmwFxwA/AJ9oE5V7FzYA4sBDcBn2AfmHEVuwAWwFJwC/AJ9oFpV7FLYAmsBLcBn2AfmHAVuwJWwFpwB/AJ9oExV7FrYA1sBHcBn2AfGHYVuwE2wFZwD/AJ9oFBV7FbYAvsBPcBn2Af6HcVuwN2wF7wAPAJPgH6XMXugT1wEDwEfIJ9oMdV7AE4AEfBI8An+ARodxV7BE7ASfAY8Ak+AVpcxZ6AM3AWPAF8gk+ARlexZ+ACXARPgX8DlqOBRr/4wwAAAABJRU5ErkJggg==') no-repeat center;
            background-size: cover;
            margin-right: 10px;
        }

        #site-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .header-buttons {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background-color: var(--hover-color);
        }

        #main-container {
            display: flex;
            max-width: 1200px;
            margin: 80px auto 20px;
            gap: 20px;
        }

        #room-list {
            width: 250px;
            border-right: 1px solid var(--border-color);
            padding-right: 20px;
            position: fixed;
            height: calc(100vh - 100px);
        }

        #chat-container {
            flex: 1;
            margin-left: 270px;
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
        }

        #chat-box {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 4px;
            background-color: var(--hover-color);
        }

        #input-area {
            display: flex;
            padding: 15px;
            gap: 10px;
            border-top: 1px solid var(--border-color);
        }

        #message-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            resize: none;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            #room-list {
                position: fixed;
                left: -250px;
                transition: left 0.3s;
                background-color: var(--bg-color);
                z-index: 1000;
                height: 100vh;
                padding: 20px;
            }
            
            #room-list.active {
                left: 0;
            }
            
            #chat-container {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="light-mode">
    <!-- 页面结构保持不变 -->
    <div id="header">[...同原HTML结构...]</div>

    <script>
        // 实时聊天功能核心代码
        let ably;
        let currentChannel;
        let currentRoom = "public-chatroom";
        let username = localStorage.getItem('username') || `用户${Math.floor(Math.random()*1000)}`;

        // 初始化实时聊天
        function initChat() {
            ably = new Ably.Realtime.Promise({
                key: 'YOU_API_KEY', // 替换为你的Ably API密钥
                echoMessages: false
            });

            // 加入默认房间
            joinRoom(currentRoom);

            // 消息接收处理
            currentChannel.subscribe((message) => {
                const msgData = message.data;
                addMessageToChat({
                    username: msgData.username,
                    content: DOMPurify.sanitize(msgData.content),
                    timestamp: new Date(msgData.timestamp).toLocaleTimeString()
                });
            });

            // 发送消息功能
            document.getElementById('send-button').addEventListener('click', () => {
                const input = document.getElementById('message-input');
                const content = input.value.trim();
                
                if(content) {
                    const message = {
                        username: username,
                        content: content,
                        timestamp: Date.now()
                    };
                    
                    currentChannel.publish('message', message);
                    input.value = '';
                }
            });

            // 房间切换功能
            document.querySelectorAll('#room-list li[data-room]').forEach(room => {
                room.addEventListener('click', () => {
                    document.querySelector('.selected')?.classList.remove('selected');
                    room.classList.add('selected');
                    currentRoom = room.dataset.room;
                    joinRoom(currentRoom);
                });
            });

            // 主题切换
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', 
                    document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            });

            // 移动端菜单切换
            document.getElementById('hamburger-menu').addEventListener('click', () => {
                document.getElementById('room-list').classList.add('active');
            });

            document.getElementById('close-room-list').addEventListener('click', () => {
                document.getElementById('room-list').classList.remove('active');
            });
        }

        // 加入房间功能
        function joinRoom(roomName) {
            if(currentChannel) {
                currentChannel.unsubscribe();
            }
            
            currentChannel = ably.channels.get(roomName);
            document.getElementById('chat-header span').textContent = 
                `${roomName.replace('-', ' ')} (在线用户：加载中...)`;

            // 获取历史消息
            currentChannel.history({limit: 50}, (err, result) => {
                document.getElementById('chat-box').innerHTML = '';
                result.items.reverse().forEach(msg => {
                    addMessageToChat({
                        username: msg.data.username,
                        content: DOMPurify.sanitize(msg.data.content),
                        timestamp: new Date(msg.data.timestamp).toLocaleTimeString()
                    });
                });
            });
        }

        // 添加消息到聊天框
        function addMessageToChat(message) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <strong>${message.username}</strong>
                <span class="time">${message.timestamp}</span>
                <p>${message.content}</p>
            `;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 初始化用户名
        document.getElementById('username-display').textContent = username;

        // 页面加载初始化
        window.addEventListener('load', () => {
            // 应用保存的主题
            if(localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }
            
            initChat();
        });

        // 钱包连接功能（示例）
        document.getElementById('connect-metamask').addEventListener('click', async () => {
            if(window.ethereum) {
                try {
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    currentUser = accounts[0];
                    document.getElementById('connect-metamask').textContent = "已连接";
                } catch (error) {
                    console.error("用户拒绝连接");
                }
            } else {
                alert("请安装MetaMask!");
            }
        });
    </script>
</body>
</html>
